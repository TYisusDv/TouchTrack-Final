<div class="d-flex no-wrap g-20 justify-content-space-between align-items-baseline">
    <h1 class="mb-20px">Administración de asistencias individuales</h1>
    <ul class="web-routes">
        <li>Administrar</li>
        <li>/</li>
        <li>Asistencias individuales</li>
    </ul>
</div>
<div class="d-flex g-20">
    <div class="col-4">
        <div class="card-number flex-wrap">
            <div class="number">
                {{total}}
            </div>
            <div class="icon">
                <i class="fa-solid fa-clipboard-user"></i>
            </div>
            <div class="col-12 pt-10px">
                <p>TOTAL</p>
            </div>
        </div>
    </div>
</div>
<div class="d-flex mt-20px justify-content-flex-end">
    <a href="javascript:;" class="btn bg-primary" id="btnExport"><i class="fa-solid fa-download mr-5px"></i> Exportar</a>
</div>
<div class="d-flex mt-10px">
    <div class="table-responsive">
        <table id="myTable" class="display" style="width: 100%;">
            <thead>
                <tr>
                    <th>Estudiante</th>
                    <th>Carrera</th>
                    <th>Semestre</th>
                    <th>Grupo</th>
                    <th>Fecha de registro</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
</div>
<script>
    $(document).ready(function() {
        var table = api_dataTable(
            "#myTable",
            "manage_attendances", 
            [
                {data: "student_format"},
                {data: "student.career.name"},
                {data: "student.semester.name"},
                {data: "student.group.name"},
                {data: "regdate"},
            ],
            {},
            [[4, 'desc']]
        );   
        
        $(document).on("click", "#btnExport", function(e){
            Swal.fire({
                title: 'Exportacion de asistencias',
                icon: 'info',
                html: `
                    <div class="form-input">
                        <i class="fa-solid fa-building-columns"></i>
                        <select id="career">
                            {% for career in careers %}
                                <option value="{{career._id}}">{{career.name}}</option>
                            {% endfor %}  
                        </select>
                    </div>
                    <div class="form-input">
                        <i class="fa-solid fa-download"></i>
                        <select id="semester">
                            {% for semester in semesters %}
                                <option value="{{semester._id}}">{{semester.name}}</option>
                            {% endfor %}  
                        </select>
                    </div>
                    <div class="form-input mb-20px">
                        <i class="fa-solid fa-people-group"></i>
                        <select id="group">
                            {% for group in groups %}
                                <option value="{{group._id}}">{{group.name}}</option>
                            {% endfor %}  
                        </select>
                    </div>
                    <label for="" class="w-100 fw-bold">Fecha entrada</label>
                    <div class="form-input mb-20px">
                        <i class="fa-solid fa-calendar-days"></i>
                        <input type="datetime-local" id="date_start" placeholder="Fecha entrada">
                    </div>
                    <label for="" class="w-100 fw-bold">Fecha salida</label>
                    <div class="form-input mb-20px">
                        <i class="fa-solid fa-calendar-days"></i>
                        <input type="datetime-local" id="date_final" placeholder="Fecha salida">
                    </div>
                `,
                showCancelButton: true,
                confirmButtonColor: '#33179c',
                cancelButtonColor: '#df4759',
                confirmButtonText: 'Exportar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    try{
                        var dateStartLocal = $('#date_start').val();
                        var dateStartObject = new Date(dateStartLocal);
                        var dateStartISO = dateStartObject.toISOString();
                    } catch(e){
                        Swal.fire(
                            '¡Ocurrio un error!',
                            "La fecha de entrada no tiene el formato predeterminado.",
                            'error'
                        );
                        return;
                    }
                
                    try{
                        var dateFinalLocal = $('#date_final').val();
                        var dateFinalObject = new Date(dateFinalLocal);
                        var dateFinalISO = dateFinalObject.toISOString();
                    } catch(e){
                        Swal.fire(
                            '¡Ocurrio un error!',
                            "La fecha de salida no tiene el formato predeterminado.",
                            'error'
                        );
                        return;
                    }

                    var formData = new FormData();
                    formData.append("action", "export_individual");
                    formData.append("career", $("#career").val());
                    formData.append("semester", $("#semester").val());
                    formData.append("group", $("#group").val());
                    formData.append("date_start", dateStartISO);
                    formData.append("date_final", dateFinalISO);

                    var response = api_sendData({url: "data/manage/attendances", type: "POST", formData: formData});
                    setTimeout(function(){
                        response.then(function (response) {
                            if(!response.success){
                                Swal.fire(
                                    '¡Ocurrio un error!',
                                    response.msg,
                                    'error'
                                );
                                $("#form-add").find(".body").prepend(api_alert({text: response.msg}));
                                return;
                            }            
                            
                            Swal.fire(
                                '¡Exito!',
                                response.msg,
                                'success'
                            );
                            window.open('/api/web/data/download/' + response.download_id, '_blank');
                            return;
                        }).catch(function (response) {
                            Swal.fire(
                                '¡Ocurrio un error!',
                                response.responseJSON.msg,
                                'error'
                            );
                            return;
                        });
                    }, 1000);
                }
            });
        });
    });
</script>